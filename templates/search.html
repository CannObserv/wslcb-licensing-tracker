{% extends "base.html" %}
{% block title %}Search ‚Äî WSLCB Licensing Tracker{% endblock %}
{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Search Records</h1>
</div>

<!-- Search & Filters -->
<form id="search-form" action="/search" method="get"
      hx-get="/search" hx-target="#results" hx-push-url="true" hx-indicator="#spinner">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 mb-6">
        <div class="mb-4">
            <input type="text" name="q" value="{{ q }}" placeholder="Search business name, license #, location, applicant..."
                   aria-label="Search records"
                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-co-purple focus:ring-1 focus:ring-co-purple px-4 py-2 border">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-[repeat(auto-fill,minmax(9rem,1fr))] gap-3">
            <div>
                <label for="section_type" class="block text-xs font-medium text-gray-500 mb-1">Record Type</label>
                <select name="section_type" id="section_type" class="w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-1.5 border">
                    <option value="">All Types</option>
                    <option value="new_application" {{ 'selected' if section_type == 'new_application' }}>New Application</option>
                    <option value="approved" {{ 'selected' if section_type == 'approved' }}>Approved</option>
                    <option value="discontinued" {{ 'selected' if section_type == 'discontinued' }}>Discontinued</option>
                </select>
            </div>
            <div>
                <label for="application_type" class="block text-xs font-medium text-gray-500 mb-1">Application Type</label>
                <select name="application_type" id="application_type" class="w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-1.5 border">
                    <option value="">All</option>
                    {% for at in filters.application_type %}
                    <option value="{{ at }}" {{ 'selected' if application_type == at }}>{{ at }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="endorsement" class="block text-xs font-medium text-gray-500 mb-1">License Type</label>
                <select name="endorsement" id="endorsement" class="w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-1.5 border">
                    <option value="">All</option>
                    {% for e in filters.endorsement %}
                    <option value="{{ e }}" {{ 'selected' if endorsement == e }}>{{ e }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="state" class="block text-xs font-medium text-gray-500 mb-1">State</label>
                <select name="state" id="state" class="w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-1.5 border">
                    <option value="">All States</option>
                    {% for s in filters.state %}
                    <option value="{{ s.code }}" {{ 'selected' if state == s.code }}>{{ s.code }} ‚Äî {{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="outcome-filter-wrapper"{% if section_type != 'new_application' %} style="display:none"{% endif %}>
                <label for="outcome_status" class="block text-xs font-medium text-gray-500 mb-1">Outcome</label>
                <select name="outcome_status" id="outcome_status" class="w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-1.5 border">
                    <option value="">All</option>
                    <option value="approved" {{ 'selected' if outcome_status == 'approved' }}>‚úÖ Approved</option>
                    <option value="discontinued" {{ 'selected' if outcome_status == 'discontinued' }}>üö´ Discontinued</option>
                    <option value="pending" {{ 'selected' if outcome_status == 'pending' }}>‚è≥ Pending</option>
                    <option value="data_gap" {{ 'selected' if outcome_status == 'data_gap' }}>üìÅ Data Unavailable</option>
                    <option value="unknown" {{ 'selected' if outcome_status == 'unknown' }}>‚ùì Unknown</option>
                </select>
            </div>
            <div id="city-filter-wrapper"{% if not state %} style="display:none"{% endif %}>
                <label for="city" class="block text-xs font-medium text-gray-500 mb-1">City</label>
                <select name="city" id="city" class="w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-1.5 border">
                    <option value="">All Cities</option>
                    {% for c in cities %}
                    <option value="{{ c }}" {{ 'selected' if city == c }}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="from_date" class="block text-xs font-medium text-gray-500 mb-1">From Date</label>
                <input type="date" name="date_from" id="from_date" value="{{ date_from }}"
                       class="w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-1.5 border">
            </div>
            <div>
                <label for="to_date" class="block text-xs font-medium text-gray-500 mb-1">To Date</label>
                <input type="date" name="date_to" id="to_date" value="{{ date_to }}"
                       class="w-full rounded-md border-gray-300 shadow-sm text-sm px-3 py-1.5 border">
            </div>
        </div>
        <div class="mt-3 flex items-center justify-between">
            <a href="/search" class="text-sm text-gray-500 hover:text-gray-700">Clear filters</a>
            <button type="submit"
                    class="bg-co-purple text-white px-6 py-2 rounded-md hover:bg-co-purple-700 font-medium">
                Search
                <span id="spinner" class="htmx-indicator ml-1">‚ü≥</span>
            </button>
        </div>
    </div>
</form>

<div id="results">
    {% include "partials/results.html" %}
</div>

<script>
// Show/hide outcome filter based on section type
document.getElementById('section_type').addEventListener('change', function() {
    const wrapper = document.getElementById('outcome-filter-wrapper');
    const select = document.getElementById('outcome_status');
    if (this.value === 'new_application') {
        wrapper.style.display = '';
    } else {
        wrapper.style.display = 'none';
        select.value = '';
    }
});

document.getElementById('state').addEventListener('change', async function() {
    const state = this.value;
    const wrapper = document.getElementById('city-filter-wrapper');
    const citySelect = document.getElementById('city');

    // Reset city selection
    citySelect.innerHTML = '<option value="">All Cities</option>';

    if (!state) {
        wrapper.style.display = 'none';
        return;
    }

    // Fetch cities for the selected state
    try {
        const resp = await fetch('/api/cities?state=' + encodeURIComponent(state));
        const cities = await resp.json();
        for (const c of cities) {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            citySelect.appendChild(opt);
        }
    } catch (e) {
        console.error('Failed to load cities:', e);
    }

    wrapper.style.display = '';
});
</script>
{% endblock %}
