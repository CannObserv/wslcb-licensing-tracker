{# Shared record table ‚Äî used by results.html and entity.html.
   Expects `records` (list of enriched record dicts) in context.
   `show_outcome` controls the Outcome column: true if any record has an outcome status,
   but hidden when the search is filtered to only approved or discontinued records. #}
{% set show_outcome = (section_type|default('') not in ('approved', 'discontinued')) and records|selectattr('outcome_status')|selectattr('outcome_status.status')|list|length > 0 %}
<div class="bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Business</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">App Type</th>
                    {% if show_outcome %}
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Outcome</th>
                    {% endif %}
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License #</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for r in records %}
                {% set ost = r.outcome_status if r.outcome_status else {} %}
                <tr class="hover:bg-gray-50 cursor-pointer focus-within:bg-gray-50"
                    tabindex="0" role="link" aria-label="View record {{ r.id }}" onclick="window.location='/record/{{ r.id }}'" onkeydown="if(event.key==='Enter')window.location='/record/{{ r.id }}'">
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900
                        {%- if show_outcome and ost.status == 'approved' %} border-l-2 border-green-300
                        {%- elif show_outcome and ost.status == 'discontinued' %} border-l-2 border-red-300
                        {%- elif show_outcome and ost.status == 'pending' %} border-l-2 border-amber-300
                        {%- elif show_outcome and ost.status == 'data_gap' %} border-l-2 border-slate-300
                        {%- elif show_outcome and ost.status == 'unknown' %} border-l-2 border-gray-300{% endif %}">{{ r.record_date }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium badge-{{ r.section_type.split('_')[0] }}">
                            {{ r.section_type | section_label }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900 max-w-xs">
                        <div class="truncate">{{ r.business_name }}</div>
                        {% if r.previous_business_name and r.previous_business_name != r.business_name %}
                        <div class="text-xs text-gray-400 truncate" title="Previous: {{ r.previous_business_name }}">‚Üê {{ r.previous_business_name }}</div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 max-w-xs">
                        <div class="truncate">{{ r.display_city }}{% if r.display_zip %}, {{ r.display_zip }}{% endif %}</div>
                        {% if r.previous_business_location %}
                        <div class="text-xs text-gray-400 truncate" title="Previous: {{ r.previous_business_location }}">‚Üê {{ r.display_previous_city }}{% if r.display_previous_zip %}, {{ r.display_previous_zip }}{% endif %}</div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 max-w-xs">
                        {% if r.endorsements %}
                        <div class="flex flex-wrap gap-0.5 max-h-12 overflow-hidden relative">
                            {% for e in r.endorsements[:3] %}
                            <span class="inline-block bg-gray-100 text-gray-700 rounded px-1.5 py-0.5 text-xs">{{ e }}</span>
                            {% endfor %}
                            {% if r.endorsements | length > 3 %}
                            <span class="inline-block bg-gray-200 text-gray-500 rounded px-1.5 py-0.5 text-xs">+{{ r.endorsements | length - 3 }}</span>
                            {% endif %}
                        </div>
                        {% else %}
                        <span class="text-gray-400 text-xs">{{ r.license_type }}</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">{{ r.application_type }}</td>
                    {% if show_outcome %}
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        {% if ost.status == 'approved' %}
                        <a href="/record/{{ ost.linked_record_id }}" class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 hover:bg-green-200" onclick="event.stopPropagation()">‚úÖ Approved</a>
                        {% elif ost.status == 'discontinued' %}
                        <a href="/record/{{ ost.linked_record_id }}" class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 hover:bg-red-200" onclick="event.stopPropagation()">üö´ Disc.</a>
                        {% elif ost.status == 'pending' %}
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">‚è≥ Pending</span>
                        {% elif ost.status == 'data_gap' %}
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600">üìÅ N/A</span>
                        {% elif ost.status == 'unknown' %}
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-500">‚ùì</span>
                        {% else %}
                        <span class="text-gray-300">‚Äî</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 font-mono">{{ r.license_number }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
