{% extends "base.html" %}
{% block title %}{{ entity.name }} — WSLCB Licensing Tracker{% endblock %}
{% block content %}
<div class="mb-6">
    <a href="/search" onclick="if(document.referrer.startsWith(location.origin)){history.back();return false;}" class="text-sm text-indigo-600 hover:text-indigo-800">← Back</a>
</div>

<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-5 border-b border-gray-200 flex justify-between items-start">
        <div>
            <h1 class="text-xl font-bold text-gray-900">{{ entity.name }}</h1>
            <p class="text-sm text-gray-500 mt-1">
                {% if entity.entity_type == 'organization' %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">Organization</span>
                {% elif entity.entity_type == 'person' %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">Person</span>
                {% endif %}
            </p>
        </div>
        <div class="text-right text-sm text-gray-500">
            <div><span class="font-semibold text-gray-900">{{ records | length }}</span> record{{ 's' if records | length != 1 }}</div>
            <div><span class="font-semibold text-gray-900">{{ unique_licenses }}</span> license{{ 's' if unique_licenses != 1 }}</div>
            <div class="text-xs text-gray-400 mt-1">First seen {{ entity.created_at[:10] if entity.created_at else '' }}</div>
        </div>
    </div>

    {% if records %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Business</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">App Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License #</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for r in records %}
                <tr class="hover:bg-gray-50 cursor-pointer focus-within:bg-gray-50" tabindex="0" role="link" aria-label="View record {{ r.id }}" onclick="window.location='/record/{{ r.id }}'" onkeydown="if(event.key==='Enter')window.location='/record/{{ r.id }}'">
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ r.record_date }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium badge-{{ r.section_type.split('_')[0] }}">
                            {{ r.section_type | section_label }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900 max-w-xs">
                        <div class="truncate">{{ r.business_name }}</div>
                        {% if r.previous_business_name and r.previous_business_name != r.business_name %}
                        <div class="text-xs text-gray-400 truncate" title="Previous: {{ r.previous_business_name }}">← {{ r.previous_business_name }}</div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 max-w-xs">
                        <div class="truncate">{{ r.display_city }}{% if r.display_zip %}, {{ r.display_zip }}{% endif %}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 max-w-xs">
                        {% if r.endorsements %}
                        <div class="flex flex-wrap gap-0.5 max-h-12 overflow-hidden">
                            {% for e in r.endorsements[:3] %}
                            <span class="inline-block bg-gray-100 text-gray-700 rounded px-1.5 py-0.5 text-xs">{{ e }}</span>
                            {% endfor %}
                            {% if r.endorsements | length > 3 %}
                            <span class="inline-block bg-gray-200 text-gray-500 rounded px-1.5 py-0.5 text-xs">+{{ r.endorsements | length - 3 }}</span>
                            {% endif %}
                        </div>
                        {% else %}
                        <span class="text-gray-400 text-xs">{{ r.license_type }}</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">{{ r.application_type }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 font-mono">{{ r.license_number }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="px-6 py-8 text-center text-sm text-gray-500">No records found for this entity.</div>
    {% endif %}
</div>
{% endblock %}
