{% extends "base.html" %}
{% block title %}Dashboard ‚Äî WSLCB Licensing Tracker{% endblock %}
{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
    <p class="mt-1 text-sm text-gray-500">Washington State Liquor &amp; Cannabis Board ‚Äî Licensing Activity Tracker</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
        <div class="text-sm font-medium text-gray-500">Total Records</div>
        <div class="mt-1 text-3xl font-bold text-gray-900">{{ "{:,}".format(stats.total_records) }}</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-blue-200 p-5">
        <div class="text-sm font-medium text-blue-600">New Applications</div>
        <div class="mt-1 text-3xl font-bold text-blue-700">{{ "{:,}".format(stats.new_application_count) }}</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-green-200 p-5">
        <div class="text-sm font-medium text-green-600">Approved</div>
        <div class="mt-1 text-3xl font-bold text-green-700">{{ "{:,}".format(stats.approved_count) }}</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-red-200 p-5">
        <div class="text-sm font-medium text-red-600">Discontinued</div>
        <div class="mt-1 text-3xl font-bold text-red-700">{{ "{:,}".format(stats.discontinued_count) }}</div>
    </div>
</div>

<!-- Additional Stats -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
        <div class="text-sm font-medium text-gray-500">Unique Businesses</div>
        <div class="mt-1 text-2xl font-bold text-gray-900">{{ "{:,}".format(stats.unique_businesses) }}</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
        <div class="text-sm font-medium text-gray-500">Unique Licenses</div>
        <div class="mt-1 text-2xl font-bold text-gray-900">{{ "{:,}".format(stats.unique_licenses) }}</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
        <div class="text-sm font-medium text-gray-500">Unique Entities</div>
        <div class="mt-1 text-2xl font-bold text-gray-900">{{ "{:,}".format(stats.unique_entities) }}</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
        <div class="text-sm font-medium text-gray-500">Date Range</div>
        {% if stats.date_range and stats.date_range[0] %}
        <div class="mt-1 text-lg font-semibold text-gray-900">{{ stats.date_range[0] }} ‚Äî {{ stats.date_range[1] }}</div>
        {% else %}
        <div class="mt-1 text-lg text-gray-400">No data yet</div>
        {% endif %}
    </div>
</div>

<!-- Last Scrape Info -->
{% if stats.last_scrape %}
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-2">Last Scrape</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div>
            <span class="text-gray-500">Status:</span>
            {% if stats.last_scrape['status'] == 'success' %}
            <span class="ml-1 text-green-600 font-medium">‚úì Success</span>
            {% elif stats.last_scrape['status'] == 'error' %}
            <span class="ml-1 text-red-600 font-medium">‚úó Error</span>
            {% else %}
            <span class="ml-1 text-yellow-600 font-medium">‚ü≥ Running</span>
            {% endif %}
        </div>
        <div>
            <span class="text-gray-500">Started:</span>
            <span class="ml-1">{{ stats.last_scrape['started_at'][:19] }}</span>
        </div>
        <div>
            <span class="text-gray-500">New records:</span>
            <span class="ml-1 font-medium">{{ (stats.last_scrape['records_new'] or 0) + (stats.last_scrape['records_approved'] or 0) + (stats.last_scrape['records_discontinued'] or 0) }}</span>
        </div>
        <div>
            <span class="text-gray-500">Skipped (dupes):</span>
            <span class="ml-1">{{ stats.last_scrape['records_skipped'] or 0 }}</span>
        </div>
    </div>
</div>
{% endif %}

<!-- Application Pipeline -->
{% if stats.pipeline and stats.pipeline.total > 0 %}
{% set p = stats.pipeline %}
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-1">Application Outcomes</h2>
    <p class="text-xs text-gray-500 mb-4">Tracks what happened to each new application ‚Äî approved, pending, or discontinued.</p>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
        <a href="/search?section_type=new_application" class="block rounded-lg border border-gray-200 p-3 hover:border-co-purple-100 hover:bg-co-purple-50/30 transition">
            <div class="text-xs font-medium text-gray-500">Total Linkable</div>
            <div class="text-xl font-bold text-gray-900">{{ "{:,}".format(p.total) }}</div>
        </a>
        <a href="/search?section_type=new_application&outcome_status=approved" class="block rounded-lg border border-green-200 p-3 hover:bg-green-50 transition">
            <div class="text-xs font-medium text-green-600">‚úÖ Approved</div>
            <div class="text-xl font-bold text-green-700">{{ "{:,}".format(p.approved) }}</div>
            <div class="text-xs text-green-600">{{ "%.0f" | format(p.approved / p.total * 100) }}%</div>
        </a>
        <a href="/search?section_type=new_application&outcome_status=pending" class="block rounded-lg border border-amber-200 p-3 hover:bg-amber-50 transition">
            <div class="text-xs font-medium text-amber-600">‚è≥ Pending</div>
            <div class="text-xl font-bold text-amber-700">{{ "{:,}".format(p.pending) }}</div>
            <div class="text-xs text-amber-600">{{ "%.0f" | format(p.pending / p.total * 100) }}%</div>
        </a>
        <a href="/search?section_type=new_application&outcome_status=unknown" class="block rounded-lg border border-gray-200 p-3 hover:bg-gray-50 transition">
            <div class="text-xs font-medium text-gray-500">‚ùì Unknown</div>
            <div class="text-xl font-bold text-gray-700">{{ "{:,}".format(p.unknown) }}</div>
            <div class="text-xs text-gray-500">{{ "%.0f" | format(p.unknown / p.total * 100) }}%</div>
        </a>
        <a href="/search?section_type=new_application&outcome_status=discontinued" class="block rounded-lg border border-red-200 p-3 hover:bg-red-50 transition">
            <div class="text-xs font-medium text-red-600">üö´ Discontinued</div>
            <div class="text-xl font-bold text-red-700">{{ "{:,}".format(p.discontinued) }}</div>
            <div class="text-xs text-red-600">{{ "%.0f" | format(p.discontinued / p.total * 100) }}%</div>
        </a>
        <a href="/search?section_type=new_application&outcome_status=data_gap" class="block rounded-lg border border-slate-200 p-3 hover:bg-slate-50 transition">
            <div class="text-xs font-medium text-slate-500">üìÅ Data Gap</div>
            <div class="text-xl font-bold text-slate-600">{{ "{:,}".format(p.data_gap) }}</div>
            <div class="text-xs text-slate-500">{{ "%.0f" | format(p.data_gap / p.total * 100) }}%</div>
        </a>
    </div>
    <p class="text-[11px] text-gray-400 mt-3">Note: Post-May 2025 NEW APPLICATION approvals not published by WSLCB due to a data transfer issue.</p>
</div>
{% endif %}

<!-- Quick Search -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Quick Search</h2>
    <form action="/search" method="get" class="flex gap-3">
        <input type="text" name="q" placeholder="Search business name, license number, location..."
               aria-label="Search records"
               class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-co-purple focus:ring-1 focus:ring-co-purple px-4 py-2 border">
        <button type="submit"
                class="bg-co-purple text-white px-6 py-2 rounded-md hover:bg-co-purple-700 font-medium">
            Search
        </button>
    </form>
</div>
{% endblock %}
